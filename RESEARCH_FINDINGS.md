# RESEARCH FINDINGS: ft (FrankenTerm) â€” TOON Integration Analysis

Researcher: SwiftWolf (codex-cli, gpt-5)  
Date: 2026-01-24  
Bead: bd-18h  
Goal: Identify exact integration surfaces for adding `--format json|toon` to `ft robot` outputs.

---

## 1. Robot Mode Inventory (What Exists Today)

Robot mode is implemented in the `ft` binary and returns a stable response envelope with command-specific `data`.

Primary implementation file:
- `crates/frankenterm/src/main.rs` (robot clap + response structs + printing)

Robot subcommands (clap):
- `help` -> `RobotHelp` (command list)
- `quick-start` (default when no subcommand) -> `RobotQuickStartData`
- `state` -> `Vec<PaneState>`
- `get-text <pane_id>` -> `RobotGetTextData`
- `send <pane_id> "<text>" [--dry-run ...]` -> either a dry-run report OR `RobotSendData`
- `wait-for <pane_id> <pattern>` -> `RobotWaitForData`
- `search "<query>"` -> `RobotSearchData`
- `events` -> `RobotEventsData`
- `workflow run|list|status|abort` -> `RobotWorkflowData` / `RobotWorkflowListData` / status data / abort data
- `why <code>` -> `RobotWhyData`
- `approve <code>` -> `RobotApproveData`

JSON schema docs exist (but appear partially out-of-sync with current Rust structs/field names):
- `docs/json-schema/wa-robot-envelope.json`
- `docs/json-schema/wa-robot-*.json` (state/get-text/send/search/events/wait-for/why/approve/workflow-*; legacy filename prefix)

Existing sample outputs (robot state only):
- `e2e-artifacts/**/robot_state*.json`

Notes on streaming/event outputs:
- `ft robot events` returns a bounded list (not a streaming JSONL feed).
- No `ft robot ... --follow` style streaming output was found in the CLI.

Inputs that accept structured JSON/TOON:
- None found in robot mode. Robot commands take positional args/flags and return structured output.

---

## 2. Current JSON Output Implementation (Exact Surfaces)

Robot responses are wrapped in a stable envelope:
- `RobotResponse<T>` in `crates/frankenterm/src/main.rs` (fields: `ok`, `data`, `error`, `error_code`, `hint`, `elapsed_ms`, `version`, `now`)

All robot commands currently print JSON to stdout via:
- `println!("{}", serde_json::to_string_pretty(&response)?);`

This call pattern is repeated for every robot subcommand inside:
- `match command { Some(Commands::Robot { .. }) => { ... } }` in `crates/frankenterm/src/main.rs`

Robot help text is generated by:
- `build_robot_help()` in `crates/frankenterm/src/main.rs`
- `build_robot_quick_start()` in `crates/frankenterm/src/main.rs`

Related (non-robot) output formatting already exists in frankenterm-core:
- `crates/frankenterm-core/src/output/format.rs` defines `OutputFormat::{Auto,Plain,Json}` and uses `FT_OUTPUT_FORMAT` env var.
  - This matters because adding TOON will likely require extending an existing format system, not introducing a second one.

---

## 3. TOON Integration Design (For bd-2oi)

### 3.1 CLI Flags and Env Var Precedence

Add robot output selection (additive; default stays JSON):
- `ft robot --format json|toon`
- `ft robot --stats` (optional; prints token stats to stderr)

Env vars:
- Tool-specific: `FT_OUTPUT_FORMAT`
- Global: `TOON_DEFAULT_FORMAT`
- Optional: `TOON_STATS=1`

Precedence (highest to lowest):
1. CLI: `ft robot --format ...`
2. `FT_OUTPUT_FORMAT`
3. `TOON_DEFAULT_FORMAT`
4. Default: `json`

Implementation note:
- `FT_OUTPUT_FORMAT` already exists and currently supports `auto|plain|json` for non-robot commands. Robot mode consults `FT_OUTPUT_FORMAT` and `TOON_DEFAULT_FORMAT` for `--format json|toon`.

### 3.2 Encoding Strategy (Recommended)

There are two viable strategies:

Option A (simplest): Encode the entire envelope as TOON when `--format toon`.
- Pros: Maximum token savings; uniform "format" behavior.
- Cons: Clients must TOON-decode before they can see `ok/error_code`.

Option B (recommended for robustness): Keep the envelope JSON, but encode only the `data` field as TOON when `--format toon`.
- Pros: Clients can always parse `ok/error_code/hint` as JSON; TOON is used for the large payload.
- Cons: Slightly less optimal compression because TOON is embedded as a JSON string.

If choosing Option B, add a small hint field to avoid ambiguity:
- Add `data_format: "json"|"toon"` (or `format: "json"|"toon"`) to the envelope when `--format` is explicitly set.

### 3.3 Code Touch Points

Minimal implementation locus (robot mode):
- `crates/frankenterm/src/main.rs`
  - Add `--format` (and optionally `--stats`) to the `Commands::Robot { ... }` clap struct.
  - Factor JSON printing into a single helper:
    - `fn print_robot_response<T: Serialize>(fmt: RobotOutputFormat, stats: bool, resp: &RobotResponse<T>)`
  - For TOON encoding: `serde_json::to_value(resp)` -> `toon_rust::encode(...)` (or encode only `data` depending on chosen strategy).

Supporting changes:
- `crates/frankenterm-core/src/output/format.rs`
  - Extend parsing to recognize `toon` (and possibly `toonl` if line-delimited output ever becomes relevant).

### 3.4 Docs Insertion Points

Update robot help payloads to mention TOON:
- `build_robot_help()` -> add `--format json|toon`, `--stats`, env vars.
- `build_robot_quick_start()` -> add a short TOON tip + precedence notes.

Update public docs:
- `README.md` robot examples currently show JSON; add a brief section documenting `--format toon`.

### 3.5 Test Plan

Unit tests (suggested location):
- Add tests in `crates/frankenterm/src/main.rs` test module OR new integration tests under `crates/frankenterm/tests/`.

Core assertions:
- Format precedence: CLI > `FT_OUTPUT_FORMAT` > `TOON_DEFAULT_FORMAT` > default.
- Round-trip: `ft robot state --format toon` decoded equals `--format json` parsed.
- Round-trip: `ft robot search --format toon` decoded equals JSON output (use a fixed fixture).
- Stats: `--stats` (or `TOON_STATS=1`) prints token comparison to stderr (stdout remains data-only).

Fixtures:
- Reuse `e2e-artifacts/**/robot_state*.json` as a baseline JSON fixture.
- Create a minimal synthetic `RobotSearchData` fixture (since no e2e search artifact exists currently).

---

## 4. Risks / Gotchas Observed

- The JSON schemas under `docs/json-schema/` do not appear to perfectly match current Rust struct field names (e.g., `total_hits` vs `total_matches`, and `pane_uuid` presence). TOON work should use "actual output" as source of truth, then reconcile schema docs as a follow-up.
- Ensure stdout is data-only for robot mode and any token stats/logging go to stderr (TOON integration should not regress this).
